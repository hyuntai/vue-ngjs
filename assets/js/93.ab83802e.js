(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{351:function(t,s,a){"use strict";a.r(s);var e=a(25),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"logical-replication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logical-replication"}},[t._v("#")]),t._v(" Logical Replication")]),t._v(" "),a("h2",{attrs:{id:"table-of-contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[t._v("#")]),t._v(" Table of Contents")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#table-of-contents"}},[t._v("Table of Contents")])]),a("li",[a("a",{attrs:{href:"#db-configuration"}},[t._v("DB Configuration")])]),a("li",[a("a",{attrs:{href:"#synchronization"}},[t._v("Synchronization")])]),a("li",[a("a",{attrs:{href:"#management-monitoring"}},[t._v("Management & Monitoring")])]),a("li",[a("a",{attrs:{href:"#trouble-shooting"}},[t._v("Trouble Shooting")])]),a("li",[a("a",{attrs:{href:"#reference"}},[t._v("Reference")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"db-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#db-configuration"}},[t._v("#")]),t._v(" DB Configuration")]),t._v(" "),a("ol",[a("li",[t._v("postgresql.conf")])]),t._v(" "),a("ul",[a("li",[t._v("NGJS 는 1:1 Active-Standby 이므로 기본 설정은 건들이지 않는다.\n"),a("ul",[a("li",[t._v("listen_address 는 개발중에 외부 Client 접속이 필요하므로 '*'로 기정의 됨")]),t._v(" "),a("li",[t._v("운영서버에 deploy 시 사설 IP Address 만 지정할 수 있음.")])])])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("   listen_addresses "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),t._v("\n   wal_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logical\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("Manual 에 나와있는 max_wal_senders, max_replication_slots 는 defaut로 남김")])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("pg_hba.conf")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# host         all            all             db_replica_private_ip_address/32      md5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v("    all             all             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            md5\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("listen_address 와 마찮가지 이유로 현재 설정 유지\n서버간 방화벽 설정이 되어있다면, 5432 포트 허용")])]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("서버 재기동(primary)")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pg_ctl restart\n")])])]),a("h2",{attrs:{id:"synchronization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#synchronization"}},[t._v("#")]),t._v(" Synchronization")]),t._v(" "),a("ol",[a("li",[t._v("primary db schema "),a("em",[a("RouterLink",{attrs:{to:"/postgres/#database-dump"}},[t._v("dump")])],1)])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("pg_dump ngdb -n public --schema-only -f ngdb-schema.sql\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("primary 에 replication 용 role 을 생성하고 권한을 부여한다.")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# create role replication with replication login password 'replication';")]),t._v("\nCREATE ROLE\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# grant all privileges on database ngdb to replication;")]),t._v("\nGRANT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# grant all privileges on all tables in schema public to replication;")]),t._v("\nGRANT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# create publication ngjs_pub for all tables;")]),t._v("\nCREATE PUBLICATION\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("primary 에 publication 을 생성한다. (전체 테이블대상)")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# create publication ngjs_pub for all tables;")]),t._v("\nCREATE PUBLICATION\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("standby data 삭제 혹은 database 재 생성. Table Schema만 존재해야 에러가 발생하지 않음)")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# \\c postgres")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("postgres")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# drop database ngdb;")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("postgres")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# create database ngdb;")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("postgres")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# \\c ngdb")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# \\i ngdb-schema.sql")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("설치 자동화를 위해서 truncate script를 준비해야 할 듯")])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("standby 에 subscription 을 생성한다.")])]),t._v(" "),a("ul",[a("li",[t._v("생성과 동시에 replication 이 시작된다.\n"),a("ul",[a("li",[t._v("초기 Data Copy 부터 실행, 이때 stanby db 에 데이타가 존재하면 dup오류 발생.")])])]),t._v(" "),a("li",[t._v("로그위치: /var/lib/pgsql/10/data/log")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("CREATE SUBSCRIPTION ngjs_sub \n       CONNECTION "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'host=10.1.1.2 port=5432 password=replication user=replication dbname=ngdb'")]),t._v("\n\t   PUBLICATION ngjs_pub \n\t   WITH "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("synchronous_commit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("remote_write"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("a",{attrs:{href:"https://www.postgresql.org/docs/10/runtime-config-wal.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.postgresql.org/docs/10/runtime-config-wal.html"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("em",[a("code",[t._v("on")])])]),t._v(" "),a("blockquote",[a("p",[t._v("commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and flushed it to disk. This ensures the transaction will not be lost unless both the primary and all synchronous standbys suffer corruption of their database storage.")])]),t._v(" "),a("p",[a("em",[a("code",[t._v("remote_apply")])])]),t._v(" "),a("blockquote",[a("p",[t._v("commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and applied it, so that it has become visible to queries on the standby(s).")])]),t._v(" "),a("p",[a("em",[a("code",[t._v("remote_write")])])]),t._v(" "),a("blockquote",[a("p",[t._v("commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and written it out to their operating system.\nThis setting is sufficient to ensure data preservation even if a standby instance of PostgreSQL were to crash,\nbut not if the standby suffers an operating-system-level crash, since the data has not necessarily reached stable > storage on the standby.")])]),t._v(" "),a("p",[a("em",[a("code",[t._v("local")])])]),t._v(" "),a("blockquote",[a("p",[t._v("commits to wait for local flush to disk, but not for replication.\nThis is not usually desirable when synchronous replication is in use, but is provided for completeness.")])]),t._v(" "),a("h2",{attrs:{id:"management-monitoring"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#management-monitoring"}},[t._v("#")]),t._v(" Management & Monitoring")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" * from pg_publication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" * from pg_stat_replication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" * from pg_replication_slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" * from pg_subscription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" * from pg_stat_subscription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[a("a",{attrs:{href:"https://pgdash.io/blog/monitoring-postgres-replication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pgdash.io/blog/monitoring-postgres-replication.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.postgresql.org/docs/10/logicaldecoding.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.postgresql.org/docs/10/logicaldecoding.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pgmetrics.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open Source Monitoring Tool - pgmetrics"),a("OutboundLink")],1)])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select * from pg_stat_replication;")]),t._v("\n  pid  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" usesysid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   usename   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" application_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" client_addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" client_hostname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" client_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("         backend_start         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" backend_xmin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n     state   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  sent_lsn  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" write_lsn  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" flush_lsn  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" replay_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" write_lag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" flush_lag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" replay_lag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" sync_priority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" sync_state \n\t -------+----------+-------------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+\n\t -----------+------------+------------+------------+------------+-----------+-----------+------------+---------------+------------\n\t  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28882")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("19893")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" replication "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ngjs_sub         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.1")]),t._v(".1.3    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("46740")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v("-04-24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(":44:27.388173+09 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  streaming "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/35E49190 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/35E49190 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/35E49190 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/35E49190 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" async\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" row"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h2",{attrs:{id:"trouble-shooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#trouble-shooting"}},[t._v("#")]),t._v(" Trouble Shooting")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.raveland.org/post/postgresql_lr_en/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Replication Error 복구방법"),a("OutboundLink")],1),a("br"),t._v(" "),a("a",{attrs:{href:"https://www.postgresql.org/docs/current/sql-dropsubscription.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Drop Subscription"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("When dropping a subscription that is associated with a replication slot on the remote host (the normal state), DROP SUBSCRIPTION will connect to the remote host and try to drop the replication slot as part of its operation."),a("br"),t._v("\nThis is necessary so that the resources allocated for the subscription on the remote host are released."),a("br"),t._v("\nIf this fails, either because the remote host is not reachable or because the remote replication slot cannot be dropped or does not exist or never existed, the DROP SUBSCRIPTION command will fail."),a("br"),t._v("\nTo proceed in this situation, disassociate the subscription from the replication slot by executing ALTER SUBSCRIPTION ... SET (slot_name = NONE)."),a("br"),t._v("\nAfter that, DROP SUBSCRIPTION will no longer attempt any actions on a remote host."),a("br"),t._v("\nNote that if the remote replication slot still exists, it should then be dropped manually;"),a("br"),t._v("\notherwise it will continue to reserve WAL and might eventually cause the disk to fill up. See also Section 31.2.1.")]),t._v(" "),a("p",[t._v("If a subscription is associated with a replication slot, then DROP SUBSCRIPTION cannot be executed inside a transaction block.")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# drop subscription ngjs_sub;")]),t._v("\nERROR:  could not connect to publisher when attempting to drop the replication slot "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ngjs_sub"')]),t._v("\nDETAIL:  The error was: FATAL:  password authentication failed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" user "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"replication"')]),t._v("\nHINT:  Use ALTER SUBSCRIPTION "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". SET "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("slot_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NONE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" to disassociate the subscription from the slot.\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ALTER SUBSCRIPTION ngjs_sub SET (slot_name = NONE);")]),t._v("\nERROR:  cannot "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" slot_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NONE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" enabled subscription\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ALTER SUBSCRPTION 전에 먼저 Disable 시켜야 함.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ALTER SUBSCRIPTION ngjs_sub DISABLE;")]),t._v("\nALTER SUBSCRIPTION\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ALTER SUBSCRIPTION ngjs_sub SET (slot_name = NONE);")]),t._v("\nALTER SUBSCRIPTION\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# drop subscription ngjs_sub;")]),t._v("\nDROP SUBSCRIPTION\n")])])]),a("ul",[a("li",[t._v("publication 을 drop 해도 replication_slot 남아있는 경우")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select pg_drop_replication_slot('ngjs_sub');")]),t._v("\nERROR:  replication slot "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ngjs_sub"')]),t._v(" is active "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" PID "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25637")]),t._v("\n")])])]),a("p",[a("a",{attrs:{href:"https://www.postgresql.org/docs/8.2/sql-drop-owned.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.postgresql.org/docs/8.2/sql-drop-owned.html"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Replication User 에 허가된 모든 Privileges 삭제")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# drop owned by replication;")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Replication User 삭제")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# drop role replication;")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# role 을 삭제한 후 ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select pg_drop_replication_slot('ngjs_sub');")]),t._v("\nERROR:  replication slot "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ngjs_sub"')]),t._v(" is active "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" PID "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20764")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kill backend replication process")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select * from pg_terminate_backend(20764);")]),t._v("\n pg_terminate_backend \n ----------------------\n  t\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" row"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Drop Replication Slot")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select pg_drop_replication_slot('ngjs_sub');")]),t._v("\n  pg_drop_replication_slot \n  --------------------------\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" row"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ngdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select * from pg_replication_slots;")]),t._v("\n slot_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" plugin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" slot_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" datoid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" database "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" temporary "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" active "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" active_pid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" xmin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" catalog_xmin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" restart_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" confirmed_flush_lsn \n -----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h2",{attrs:{id:"reference"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" Reference")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.postgresql.org/docs/10/logical-replication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.postgresql.org/docs/10/logical-replication.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pgdash.io/blog/monitoring-postgres-replication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pgdash.io/blog/monitoring-postgres-replication.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.postgresql.org/docs/10/different-replication-solutions.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Comparison of Different Solutions"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.digitalocean.com/community/tutorials/how-to-set-up-logical-replication-with-postgresql-10-on-ubuntu-18-04",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.digitalocean.com/community/tutorials/how-to-set-up-logical-replication-with-postgresql-10-on-ubuntu-18-04"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://severalnines.com/blog/postgresql-streaming-replication-vs-logical-replication",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://severalnines.com/blog/postgresql-streaming-replication-vs-logical-replication"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://browndwarf.tistory.com/4",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://browndwarf.tistory.com/4"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);