<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Logical Replication | PCP2</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="Powered by Vuepress">
    <link rel="preload" href="/assets/css/0.styles.6eae85bc.css" as="style"><link rel="preload" href="/assets/js/app.8ffdba78.js" as="script"><link rel="preload" href="/assets/js/2.289f00f2.js" as="script"><link rel="preload" href="/assets/js/93.ab83802e.js" as="script"><link rel="prefetch" href="/assets/js/10.37739cda.js"><link rel="prefetch" href="/assets/js/100.3e8dc1c7.js"><link rel="prefetch" href="/assets/js/101.8e3a9cd6.js"><link rel="prefetch" href="/assets/js/102.1a61e83e.js"><link rel="prefetch" href="/assets/js/103.eea48eac.js"><link rel="prefetch" href="/assets/js/104.4241bdd4.js"><link rel="prefetch" href="/assets/js/105.b7bd79b0.js"><link rel="prefetch" href="/assets/js/106.e8656725.js"><link rel="prefetch" href="/assets/js/107.1f2b88d3.js"><link rel="prefetch" href="/assets/js/108.8bd217ab.js"><link rel="prefetch" href="/assets/js/109.5ef39c62.js"><link rel="prefetch" href="/assets/js/11.28dcb141.js"><link rel="prefetch" href="/assets/js/110.6197e2a6.js"><link rel="prefetch" href="/assets/js/111.543ff849.js"><link rel="prefetch" href="/assets/js/112.44a9fedc.js"><link rel="prefetch" href="/assets/js/113.bef6fabf.js"><link rel="prefetch" href="/assets/js/114.d028463c.js"><link rel="prefetch" href="/assets/js/115.95ad0416.js"><link rel="prefetch" href="/assets/js/116.15c9a80e.js"><link rel="prefetch" href="/assets/js/117.f7a90961.js"><link rel="prefetch" href="/assets/js/118.6c9a9bf4.js"><link rel="prefetch" href="/assets/js/119.bc4889f0.js"><link rel="prefetch" href="/assets/js/12.9a212ea2.js"><link rel="prefetch" href="/assets/js/120.4a9517f7.js"><link rel="prefetch" href="/assets/js/13.dde36bba.js"><link rel="prefetch" href="/assets/js/14.ea96180d.js"><link rel="prefetch" href="/assets/js/15.f2ead00f.js"><link rel="prefetch" href="/assets/js/16.aa58a22e.js"><link rel="prefetch" href="/assets/js/17.8eeecb85.js"><link rel="prefetch" href="/assets/js/18.f7413a74.js"><link rel="prefetch" href="/assets/js/19.35432611.js"><link rel="prefetch" href="/assets/js/20.d6fefe26.js"><link rel="prefetch" href="/assets/js/21.10f4ef05.js"><link rel="prefetch" href="/assets/js/22.6ad61f8f.js"><link rel="prefetch" href="/assets/js/23.4f459d67.js"><link rel="prefetch" href="/assets/js/24.8209cda9.js"><link rel="prefetch" href="/assets/js/25.f56e04f0.js"><link rel="prefetch" href="/assets/js/26.57ea17ba.js"><link rel="prefetch" href="/assets/js/27.371683a1.js"><link rel="prefetch" href="/assets/js/28.be449e4c.js"><link rel="prefetch" href="/assets/js/29.5540732a.js"><link rel="prefetch" href="/assets/js/3.17fefa39.js"><link rel="prefetch" href="/assets/js/30.b84d76aa.js"><link rel="prefetch" href="/assets/js/31.d0bf2460.js"><link rel="prefetch" href="/assets/js/32.ddc55a03.js"><link rel="prefetch" href="/assets/js/33.53942cbb.js"><link rel="prefetch" href="/assets/js/34.a6dd1d99.js"><link rel="prefetch" href="/assets/js/35.9c4566cc.js"><link rel="prefetch" href="/assets/js/36.323a0a4e.js"><link rel="prefetch" href="/assets/js/37.79c12810.js"><link rel="prefetch" href="/assets/js/38.d9446123.js"><link rel="prefetch" href="/assets/js/39.4f597719.js"><link rel="prefetch" href="/assets/js/4.d9fc537a.js"><link rel="prefetch" href="/assets/js/40.58681695.js"><link rel="prefetch" href="/assets/js/41.f7d976ea.js"><link rel="prefetch" href="/assets/js/42.6084c745.js"><link rel="prefetch" href="/assets/js/43.ea7191b1.js"><link rel="prefetch" href="/assets/js/44.a4ca02fb.js"><link rel="prefetch" href="/assets/js/45.35dfc34e.js"><link rel="prefetch" href="/assets/js/46.62a25281.js"><link rel="prefetch" href="/assets/js/47.ab1de369.js"><link rel="prefetch" href="/assets/js/48.cba59239.js"><link rel="prefetch" href="/assets/js/49.eb239dd5.js"><link rel="prefetch" href="/assets/js/5.df852f74.js"><link rel="prefetch" href="/assets/js/50.39258016.js"><link rel="prefetch" href="/assets/js/51.bd6a02f9.js"><link rel="prefetch" href="/assets/js/52.a02b0b49.js"><link rel="prefetch" href="/assets/js/53.b3efcb6a.js"><link rel="prefetch" href="/assets/js/54.a84a2f60.js"><link rel="prefetch" href="/assets/js/55.3514f5c9.js"><link rel="prefetch" href="/assets/js/56.6af3b33c.js"><link rel="prefetch" href="/assets/js/57.c0b76a9c.js"><link rel="prefetch" href="/assets/js/58.4368049c.js"><link rel="prefetch" href="/assets/js/59.152307f3.js"><link rel="prefetch" href="/assets/js/6.ce4143b2.js"><link rel="prefetch" href="/assets/js/60.149c27ea.js"><link rel="prefetch" href="/assets/js/61.e427dbfc.js"><link rel="prefetch" href="/assets/js/62.98259169.js"><link rel="prefetch" href="/assets/js/63.3e7779eb.js"><link rel="prefetch" href="/assets/js/64.e1a191cf.js"><link rel="prefetch" href="/assets/js/65.3c82ac17.js"><link rel="prefetch" href="/assets/js/66.15ee025b.js"><link rel="prefetch" href="/assets/js/67.b9de67a6.js"><link rel="prefetch" href="/assets/js/68.cb55fc8a.js"><link rel="prefetch" href="/assets/js/69.32a92b57.js"><link rel="prefetch" href="/assets/js/7.0db5ec6a.js"><link rel="prefetch" href="/assets/js/70.a76e6599.js"><link rel="prefetch" href="/assets/js/71.54b161b9.js"><link rel="prefetch" href="/assets/js/72.7c7c1c71.js"><link rel="prefetch" href="/assets/js/73.fe43b050.js"><link rel="prefetch" href="/assets/js/74.b03431a5.js"><link rel="prefetch" href="/assets/js/75.f15c4e7f.js"><link rel="prefetch" href="/assets/js/76.009006de.js"><link rel="prefetch" href="/assets/js/77.dc020caf.js"><link rel="prefetch" href="/assets/js/78.04862f9f.js"><link rel="prefetch" href="/assets/js/79.009f9538.js"><link rel="prefetch" href="/assets/js/8.e136e53c.js"><link rel="prefetch" href="/assets/js/80.216b8b14.js"><link rel="prefetch" href="/assets/js/81.33002096.js"><link rel="prefetch" href="/assets/js/82.df05a617.js"><link rel="prefetch" href="/assets/js/83.49f87cbc.js"><link rel="prefetch" href="/assets/js/84.88032142.js"><link rel="prefetch" href="/assets/js/85.75584ddd.js"><link rel="prefetch" href="/assets/js/86.5e87f2d2.js"><link rel="prefetch" href="/assets/js/87.ffe564df.js"><link rel="prefetch" href="/assets/js/88.ae49c532.js"><link rel="prefetch" href="/assets/js/89.bac84ade.js"><link rel="prefetch" href="/assets/js/9.a7acd8e0.js"><link rel="prefetch" href="/assets/js/90.e2240291.js"><link rel="prefetch" href="/assets/js/91.f864ae9f.js"><link rel="prefetch" href="/assets/js/92.9d6bef25.js"><link rel="prefetch" href="/assets/js/94.7eea4a66.js"><link rel="prefetch" href="/assets/js/95.c06032ff.js"><link rel="prefetch" href="/assets/js/96.873c92e4.js"><link rel="prefetch" href="/assets/js/97.6a59b3fe.js"><link rel="prefetch" href="/assets/js/98.6b1cd2ae.js"><link rel="prefetch" href="/assets/js/99.f2296627.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6eae85bc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PCP2</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/feature/feature.html" class="nav-link">Feature</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">User Guide</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>시작하기</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/overview.html" class="nav-link">Overview</a></li><li class="dropdown-subitem"><a href="/manual/installation-guide.html" class="nav-link">클라이언트 설치</a></li></ul></li><li class="dropdown-item"><h4>PCP 일반</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/basic-views.html" class="nav-link">기본 화면</a></li><li class="dropdown-subitem"><a href="/manual/auth-manage.html" class="nav-link">사용자 및 권한관리</a></li><li class="dropdown-subitem"><a href="/manual/job-properties.html" class="nav-link">잡 속성</a></li></ul></li><li class="dropdown-item"><h4>Tools</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/master-jobs.html" class="nav-link">잡 등록 및 관리</a></li><li class="dropdown-subitem"><a href="/manual/export-import.html" class="nav-link">Export And Import</a></li><li class="dropdown-subitem"><a href="/manual/group-filter.html" class="nav-link">Group Order And Filter</a></li><li class="dropdown-subitem"><a href="/manual/conditions.html" class="nav-link">Conditions</a></li><li class="dropdown-subitem"><a href="/manual/calendar.html" class="nav-link">Calendar</a></li><li class="dropdown-subitem"><a href="/manual/node-manage.html" class="nav-link">노드 관리</a></li><li class="dropdown-subitem"><a href="/manual/variables.html" class="nav-link">Variables</a></li><li class="dropdown-subitem"><a href="/manual/remote-data-sync.html" class="nav-link">원격 데이터 동기화</a></li></ul></li><li class="dropdown-item"><h4>Monitor</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/server-monitor.html" class="nav-link">서버 모니터링</a></li><li class="dropdown-subitem"><a href="/manual/process-monitor.html" class="nav-link">프로세스 모니터링</a></li><li class="dropdown-subitem"><a href="/manual/audit-log.html" class="nav-link">Audit Log</a></li></ul></li><li class="dropdown-item"><!----> <a href="/manual/views.html" class="nav-link">Views</a></li><li class="dropdown-item"><h4>System</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/about.html" class="nav-link">About</a></li><li class="dropdown-subitem"><a href="/manual/check-update.html" class="nav-link">Check for update</a></li><li class="dropdown-subitem"><a href="/manual/preferences.html" class="nav-link">Preferences</a></li></ul></li><li class="dropdown-item"><h4>ETC</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/user-api.html" class="nav-link">API 가이드</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Postgres</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/postgres/version.html" class="nav-link">version</a></li><li class="dropdown-item"><!----> <a href="/postgres/command.html" class="nav-link">command</a></li><li class="dropdown-item"><!----> <a href="/postgres/logical-replication.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">replication</a></li><li class="dropdown-item"><!----> <a href="/postgres/procedure.html" class="nav-link">procedure</a></li><li class="dropdown-item"><!----> <a href="/postgres/configuration.html" class="nav-link">configuration</a></li><li class="dropdown-item"><!----> <a href="/postgres/high-availability.html" class="nav-link">high-availability</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Practice</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/practice/vuepress.html" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/practice/sample.html" class="nav-link">vuepress.sample</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/practice/psql.html" class="nav-link">psql</a></li><li class="dropdown-item"><!----> <a href="/practice/install.html" class="nav-link">install</a></li><li class="dropdown-item"><!----> <a href="/practice/install-db.html" class="nav-link">install-db</a></li><li class="dropdown-item"><!----> <a href="/practice/bash-programming.html" class="nav-link">bash-programming</a></li><li class="dropdown-item"><!----> <a href="/practice/system.html" class="nav-link">system</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/feature/feature.html" class="nav-link">Feature</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">User Guide</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>시작하기</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/overview.html" class="nav-link">Overview</a></li><li class="dropdown-subitem"><a href="/manual/installation-guide.html" class="nav-link">클라이언트 설치</a></li></ul></li><li class="dropdown-item"><h4>PCP 일반</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/basic-views.html" class="nav-link">기본 화면</a></li><li class="dropdown-subitem"><a href="/manual/auth-manage.html" class="nav-link">사용자 및 권한관리</a></li><li class="dropdown-subitem"><a href="/manual/job-properties.html" class="nav-link">잡 속성</a></li></ul></li><li class="dropdown-item"><h4>Tools</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/master-jobs.html" class="nav-link">잡 등록 및 관리</a></li><li class="dropdown-subitem"><a href="/manual/export-import.html" class="nav-link">Export And Import</a></li><li class="dropdown-subitem"><a href="/manual/group-filter.html" class="nav-link">Group Order And Filter</a></li><li class="dropdown-subitem"><a href="/manual/conditions.html" class="nav-link">Conditions</a></li><li class="dropdown-subitem"><a href="/manual/calendar.html" class="nav-link">Calendar</a></li><li class="dropdown-subitem"><a href="/manual/node-manage.html" class="nav-link">노드 관리</a></li><li class="dropdown-subitem"><a href="/manual/variables.html" class="nav-link">Variables</a></li><li class="dropdown-subitem"><a href="/manual/remote-data-sync.html" class="nav-link">원격 데이터 동기화</a></li></ul></li><li class="dropdown-item"><h4>Monitor</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/server-monitor.html" class="nav-link">서버 모니터링</a></li><li class="dropdown-subitem"><a href="/manual/process-monitor.html" class="nav-link">프로세스 모니터링</a></li><li class="dropdown-subitem"><a href="/manual/audit-log.html" class="nav-link">Audit Log</a></li></ul></li><li class="dropdown-item"><!----> <a href="/manual/views.html" class="nav-link">Views</a></li><li class="dropdown-item"><h4>System</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/about.html" class="nav-link">About</a></li><li class="dropdown-subitem"><a href="/manual/check-update.html" class="nav-link">Check for update</a></li><li class="dropdown-subitem"><a href="/manual/preferences.html" class="nav-link">Preferences</a></li></ul></li><li class="dropdown-item"><h4>ETC</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/manual/user-api.html" class="nav-link">API 가이드</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Postgres</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/postgres/version.html" class="nav-link">version</a></li><li class="dropdown-item"><!----> <a href="/postgres/command.html" class="nav-link">command</a></li><li class="dropdown-item"><!----> <a href="/postgres/logical-replication.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">replication</a></li><li class="dropdown-item"><!----> <a href="/postgres/procedure.html" class="nav-link">procedure</a></li><li class="dropdown-item"><!----> <a href="/postgres/configuration.html" class="nav-link">configuration</a></li><li class="dropdown-item"><!----> <a href="/postgres/high-availability.html" class="nav-link">high-availability</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Practice</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/practice/vuepress.html" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/practice/sample.html" class="nav-link">vuepress.sample</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/practice/psql.html" class="nav-link">psql</a></li><li class="dropdown-item"><!----> <a href="/practice/install.html" class="nav-link">install</a></li><li class="dropdown-item"><!----> <a href="/practice/install-db.html" class="nav-link">install-db</a></li><li class="dropdown-item"><!----> <a href="/practice/bash-programming.html" class="nav-link">bash-programming</a></li><li class="dropdown-item"><!----> <a href="/practice/system.html" class="nav-link">system</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="logical-replication"><a href="#logical-replication" class="header-anchor">#</a> Logical Replication</h1> <h2 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table of Contents</h2> <p></p><div class="table-of-contents"><ul><li><a href="#table-of-contents">Table of Contents</a></li><li><a href="#db-configuration">DB Configuration</a></li><li><a href="#synchronization">Synchronization</a></li><li><a href="#management-monitoring">Management &amp; Monitoring</a></li><li><a href="#trouble-shooting">Trouble Shooting</a></li><li><a href="#reference">Reference</a></li></ul></div><p></p> <h2 id="db-configuration"><a href="#db-configuration" class="header-anchor">#</a> DB Configuration</h2> <ol><li>postgresql.conf</li></ol> <ul><li>NGJS 는 1:1 Active-Standby 이므로 기본 설정은 건들이지 않는다.
<ul><li>listen_address 는 개발중에 외부 Client 접속이 필요하므로 '*'로 기정의 됨</li> <li>운영서버에 deploy 시 사설 IP Address 만 지정할 수 있음.</li></ul></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>   listen_addresses <span class="token operator">=</span> <span class="token string">'*'</span>
   wal_level <span class="token operator">=</span> logical
</code></pre></div><div class="custom-block tip"><p>Manual 에 나와있는 max_wal_senders, max_replication_slots 는 defaut로 남김</p></div> <ol start="2"><li>pg_hba.conf</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># host         all            all             db_replica_private_ip_address/32      md5</span>
<span class="token function">host</span>    all             all             <span class="token number">0.0</span>.0.0/0            md5
</code></pre></div><div class="custom-block tip"><p>listen_address 와 마찮가지 이유로 현재 설정 유지
서버간 방화벽 설정이 되어있다면, 5432 포트 허용</p></div> <ol start="3"><li>서버 재기동(primary)</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>pg_ctl restart
</code></pre></div><h2 id="synchronization"><a href="#synchronization" class="header-anchor">#</a> Synchronization</h2> <ol><li>primary db schema <em><a href="/postgres/#database-dump">dump</a></em></li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code>pg_dump ngdb -n public --schema-only -f ngdb-schema.sql
</code></pre></div><ol start="2"><li>primary 에 replication 용 role 을 생성하고 권한을 부여한다.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># create role replication with replication login password 'replication';</span>
CREATE ROLE
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># grant all privileges on database ngdb to replication;</span>
GRANT
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># grant all privileges on all tables in schema public to replication;</span>
GRANT
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># create publication ngjs_pub for all tables;</span>
CREATE PUBLICATION
</code></pre></div><ol start="3"><li>primary 에 publication 을 생성한다. (전체 테이블대상)</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># create publication ngjs_pub for all tables;</span>
CREATE PUBLICATION
</code></pre></div><ol start="4"><li>standby data 삭제 혹은 database 재 생성. Table Schema만 존재해야 에러가 발생하지 않음)</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># \c postgres</span>
<span class="token assign-left variable">postgres</span><span class="token operator">=</span><span class="token comment"># drop database ngdb;</span>
<span class="token assign-left variable">postgres</span><span class="token operator">=</span><span class="token comment"># create database ngdb;</span>
<span class="token assign-left variable">postgres</span><span class="token operator">=</span><span class="token comment"># \c ngdb</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># \i ngdb-schema.sql</span>
</code></pre></div><div class="custom-block tip"><p>설치 자동화를 위해서 truncate script를 준비해야 할 듯</p></div> <ol start="5"><li>standby 에 subscription 을 생성한다.</li></ol> <ul><li>생성과 동시에 replication 이 시작된다.
<ul><li>초기 Data Copy 부터 실행, 이때 stanby db 에 데이타가 존재하면 dup오류 발생.</li></ul></li> <li>로그위치: /var/lib/pgsql/10/data/log</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>CREATE SUBSCRIPTION ngjs_sub 
       CONNECTION <span class="token string">'host=10.1.1.2 port=5432 password=replication user=replication dbname=ngdb'</span>
	   PUBLICATION ngjs_pub 
	   WITH <span class="token punctuation">(</span>synchronous_commit<span class="token operator">=</span>remote_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="https://www.postgresql.org/docs/10/runtime-config-wal.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/10/runtime-config-wal.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><em><code>on</code></em></p> <blockquote><p>commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and flushed it to disk. This ensures the transaction will not be lost unless both the primary and all synchronous standbys suffer corruption of their database storage.</p></blockquote> <p><em><code>remote_apply</code></em></p> <blockquote><p>commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and applied it, so that it has become visible to queries on the standby(s).</p></blockquote> <p><em><code>remote_write</code></em></p> <blockquote><p>commits will wait until replies from the current synchronous standby(s) indicate they have received the commit record of the transaction and written it out to their operating system.
This setting is sufficient to ensure data preservation even if a standby instance of PostgreSQL were to crash,
but not if the standby suffers an operating-system-level crash, since the data has not necessarily reached stable &gt; storage on the standby.</p></blockquote> <p><em><code>local</code></em></p> <blockquote><p>commits to wait for local flush to disk, but not for replication.
This is not usually desirable when synchronous replication is in use, but is provided for completeness.</p></blockquote> <h2 id="management-monitoring"><a href="#management-monitoring" class="header-anchor">#</a> Management &amp; Monitoring</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from pg_publication<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from pg_stat_replication<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from pg_replication_slots<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from pg_subscription<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from pg_stat_subscription<span class="token punctuation">;</span>
</code></pre></div><ul><li><a href="https://pgdash.io/blog/monitoring-postgres-replication.html" target="_blank" rel="noopener noreferrer">https://pgdash.io/blog/monitoring-postgres-replication.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.postgresql.org/docs/10/logicaldecoding.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/10/logicaldecoding.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pgmetrics.io/" target="_blank" rel="noopener noreferrer">Open Source Monitoring Tool - pgmetrics<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select * from pg_stat_replication;</span>
  pid  <span class="token operator">|</span> usesysid <span class="token operator">|</span>   usename   <span class="token operator">|</span> application_name <span class="token operator">|</span> client_addr <span class="token operator">|</span> client_hostname <span class="token operator">|</span> client_port <span class="token operator">|</span>         backend_start         <span class="token operator">|</span> backend_xmin <span class="token operator">|</span>
     state   <span class="token operator">|</span>  sent_lsn  <span class="token operator">|</span> write_lsn  <span class="token operator">|</span> flush_lsn  <span class="token operator">|</span> replay_lsn <span class="token operator">|</span> write_lag <span class="token operator">|</span> flush_lag <span class="token operator">|</span> replay_lag <span class="token operator">|</span> sync_priority <span class="token operator">|</span> sync_state 
	 -------+----------+-------------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+
	 -----------+------------+------------+------------+------------+-----------+-----------+------------+---------------+------------
	  <span class="token number">28882</span> <span class="token operator">|</span>    <span class="token number">19893</span> <span class="token operator">|</span> replication <span class="token operator">|</span> ngjs_sub         <span class="token operator">|</span> <span class="token number">10.1</span>.1.3    <span class="token operator">|</span>                 <span class="token operator">|</span>       <span class="token number">46740</span> <span class="token operator">|</span> <span class="token number">2019</span>-04-24 <span class="token number">14</span>:44:27.388173+09 <span class="token operator">|</span>             <span class="token operator">|</span>
  streaming <span class="token operator">|</span> <span class="token number">0</span>/35E49190 <span class="token operator">|</span> <span class="token number">0</span>/35E49190 <span class="token operator">|</span> <span class="token number">0</span>/35E49190 <span class="token operator">|</span> <span class="token number">0</span>/35E49190 <span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>            <span class="token operator">|</span>             <span class="token number">0</span> <span class="token operator">|</span> async
	<span class="token punctuation">(</span><span class="token number">1</span> row<span class="token punctuation">)</span>
</code></pre></div><h2 id="trouble-shooting"><a href="#trouble-shooting" class="header-anchor">#</a> Trouble Shooting</h2> <p><a href="https://blog.raveland.org/post/postgresql_lr_en/" target="_blank" rel="noopener noreferrer">Replication Error 복구방법<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://www.postgresql.org/docs/current/sql-dropsubscription.html" target="_blank" rel="noopener noreferrer">Drop Subscription<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="custom-block tip"><p>When dropping a subscription that is associated with a replication slot on the remote host (the normal state), DROP SUBSCRIPTION will connect to the remote host and try to drop the replication slot as part of its operation.<br>
This is necessary so that the resources allocated for the subscription on the remote host are released.<br>
If this fails, either because the remote host is not reachable or because the remote replication slot cannot be dropped or does not exist or never existed, the DROP SUBSCRIPTION command will fail.<br>
To proceed in this situation, disassociate the subscription from the replication slot by executing ALTER SUBSCRIPTION ... SET (slot_name = NONE).<br>
After that, DROP SUBSCRIPTION will no longer attempt any actions on a remote host.<br>
Note that if the remote replication slot still exists, it should then be dropped manually;<br>
otherwise it will continue to reserve WAL and might eventually cause the disk to fill up. See also Section 31.2.1.</p> <p>If a subscription is associated with a replication slot, then DROP SUBSCRIPTION cannot be executed inside a transaction block.</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># drop subscription ngjs_sub;</span>
ERROR:  could not connect to publisher when attempting to drop the replication slot <span class="token string">&quot;ngjs_sub&quot;</span>
DETAIL:  The error was: FATAL:  password authentication failed <span class="token keyword">for</span> user <span class="token string">&quot;replication&quot;</span>
HINT:  Use ALTER SUBSCRIPTION <span class="token punctuation">..</span>. SET <span class="token punctuation">(</span>slot_name <span class="token operator">=</span> NONE<span class="token punctuation">)</span> to disassociate the subscription from the slot.
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># ALTER SUBSCRIPTION ngjs_sub SET (slot_name = NONE);</span>
ERROR:  cannot <span class="token builtin class-name">set</span> slot_name <span class="token operator">=</span> NONE <span class="token keyword">for</span> enabled subscription
<span class="token comment"># ALTER SUBSCRPTION 전에 먼저 Disable 시켜야 함.</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># ALTER SUBSCRIPTION ngjs_sub DISABLE;</span>
ALTER SUBSCRIPTION
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># ALTER SUBSCRIPTION ngjs_sub SET (slot_name = NONE);</span>
ALTER SUBSCRIPTION
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># drop subscription ngjs_sub;</span>
DROP SUBSCRIPTION
</code></pre></div><ul><li>publication 을 drop 해도 replication_slot 남아있는 경우</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select pg_drop_replication_slot('ngjs_sub');</span>
ERROR:  replication slot <span class="token string">&quot;ngjs_sub&quot;</span> is active <span class="token keyword">for</span> PID <span class="token number">25637</span>
</code></pre></div><p><a href="https://www.postgresql.org/docs/8.2/sql-drop-owned.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/8.2/sql-drop-owned.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Replication User 에 허가된 모든 Privileges 삭제</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># drop owned by replication;</span>
<span class="token comment"># Replication User 삭제</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># drop role replication;</span>
<span class="token comment"># role 을 삭제한 후 </span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select pg_drop_replication_slot('ngjs_sub');</span>
ERROR:  replication slot <span class="token string">&quot;ngjs_sub&quot;</span> is active <span class="token keyword">for</span> PID <span class="token number">20764</span>
<span class="token comment"># kill backend replication process</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select * from pg_terminate_backend(20764);</span>
 pg_terminate_backend 
 ----------------------
  t
 <span class="token punctuation">(</span><span class="token number">1</span> row<span class="token punctuation">)</span>
<span class="token comment"># Drop Replication Slot</span>
<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select pg_drop_replication_slot('ngjs_sub');</span>
  pg_drop_replication_slot 
  --------------------------
  <span class="token punctuation">(</span><span class="token number">1</span> row<span class="token punctuation">)</span>

<span class="token assign-left variable">ngdb</span><span class="token operator">=</span><span class="token comment"># select * from pg_replication_slots;</span>
 slot_name <span class="token operator">|</span> plugin <span class="token operator">|</span> slot_type <span class="token operator">|</span> datoid <span class="token operator">|</span> database <span class="token operator">|</span> temporary <span class="token operator">|</span> active <span class="token operator">|</span> active_pid <span class="token operator">|</span> xmin <span class="token operator">|</span> catalog_xmin <span class="token operator">|</span> restart_lsn <span class="token operator">|</span> confirmed_flush_lsn 
 -----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------
 <span class="token punctuation">(</span><span class="token number">0</span> rows<span class="token punctuation">)</span>
</code></pre></div><h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ul><li><a href="https://www.postgresql.org/docs/10/logical-replication.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/10/logical-replication.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pgdash.io/blog/monitoring-postgres-replication.html" target="_blank" rel="noopener noreferrer">https://pgdash.io/blog/monitoring-postgres-replication.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.postgresql.org/docs/10/different-replication-solutions.html" target="_blank" rel="noopener noreferrer">Comparison of Different Solutions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-logical-replication-with-postgresql-10-on-ubuntu-18-04" target="_blank" rel="noopener noreferrer">https://www.digitalocean.com/community/tutorials/how-to-set-up-logical-replication-with-postgresql-10-on-ubuntu-18-04<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://severalnines.com/blog/postgresql-streaming-replication-vs-logical-replication" target="_blank" rel="noopener noreferrer">https://severalnines.com/blog/postgresql-streaming-replication-vs-logical-replication<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://browndwarf.tistory.com/4" target="_blank" rel="noopener noreferrer">https://browndwarf.tistory.com/4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">6/30/2020, 3:00:34 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8ffdba78.js" defer></script><script src="/assets/js/2.289f00f2.js" defer></script><script src="/assets/js/93.ab83802e.js" defer></script>
  </body>
</html>
